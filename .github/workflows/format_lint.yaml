name: Format and Lint CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    # Detect which apps have changes
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            web: ${{ steps.filter.outputs.web }}
            server: ${{ steps.filter.outputs.server }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Detect file changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                filters: |
                    web:
                        - 'apps/web/**'
                        - 'packages/**'
                    server:
                        - 'apps/server/**'
                        - 'packages/**'

    # Lint and format web app
    lint-web:
        needs: detect-changes
        if: needs.detect-changes.outputs.web == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 9.0.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: "20"
                cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Format web
              run: pnpm --filter @flagout/web format

            - name: Lint web
              run: pnpm --filter @flagout/web lint

    # Lint and format server app
    lint-server:
        needs: detect-changes
        if: needs.detect-changes.outputs.server == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 9.0.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: "20"
                cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Format server
              run: pnpm --filter @flagout/server format

            - name: Lint server
              run: pnpm --filter @flagout/server lint
